{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 159, "column": 0}, "map": {"version":3,"sources":["file:///Users/shreyansh/messaging-app/client/src/app/messages/page.tsx"],"sourcesContent":["'use client';\n\nimport { useState, useEffect, useRef } from 'react';\nimport { useRouter } from 'next/navigation';\nimport { io, Socket } from 'socket.io-client';\n\n\ninterface Message {\n    senderId: string;\n    senderUsername: string,\n    content: string;\n    timestamp: string;\n}\n\ninterface Conversation {\n    id: string;\n    email: string;\n    username?: string;\n}\n\nexport default function MessagesPage() {\n    const [conversations, setConversations] = useState<Conversation[]>([]);\n    const [selectedConversation, setSelectedConversation] = useState<Conversation | null>(null);\n    const [messages, setMessages] = useState<Message[]>([]);\n    const [newMessage, setNewMessage] = useState('');\n    const [allUsers, setAllUsers] = useState<Conversation[]>([]);\n    const [showUserList, setShowUserList] = useState(false);\n    const [currentUserEmail, setCurrentUserEmail] = useState('');\n    const [currentUserId, setCurrentUserId] = useState('');\n    const [currentUsername, setCurrentUsername] = useState('');\n    const router = useRouter();\n    const messagesEndRef = useRef<HTMLDivElement>(null);\n    const prevMessageCountRef = useRef<number>(0);\n    const socketRef = useRef<Socket | null>(null);\n\n    // connect socket\n    useEffect(() => {\n        socketRef.current = io('http://localhost:6543');\n        return () => {\n            socketRef.current?.disconnect();\n        };\n    }, []);\n\n    useEffect(() => {\n        if (!socketRef.current) return;\n        const handleReceiveMessage = (message: Message) => {\n            if (\n                selectedConversation &&\n                (message.senderId === selectedConversation.id || message.senderId === currentUserId)\n              ) {\n                setMessages((prev) => [...prev, message]);\n              }\n        }\n\n        socketRef.current.on('receive_message', handleReceiveMessage);\n\n        return () => {\n            socketRef.current?.off('receive_message', handleReceiveMessage);\n        };\n    }, [selectedConversation]);\n\n    // autoscroll to most recent message\n    useEffect(() => {\n        if (messages.length > prevMessageCountRef.current) {\n            messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });\n        }\n        prevMessageCountRef.current = messages.length;\n    }, [messages]);\n\n    // labeling messages\n    useEffect(() => {\n        const token = localStorage.getItem('token');\n        if (!token) return;\n\n        const fetchMe = async () => {\n            const res = await fetch('http://localhost:6543/api/me', {\n                headers: {\n                    Authorization: `Bearer ${token}`,\n                },\n            });\n            const data = await res.json();\n            setCurrentUserEmail(data.email);\n            setCurrentUserId(data.id);\n            setCurrentUsername(data.username);\n            socketRef.current?.emit('register', data.id);\n        };\n\n        fetchMe();\n    }, []);\n\n    // fetch possible new users to talk to\n    useEffect(() => {\n        // fetch users only once on mount\n        const token = localStorage.getItem('token');\n        if (!token) {\n            router.push('/login');\n            return;\n        }\n\n        const fetchUsers = async () => {\n            const res = await fetch('http://localhost:6543/api/users', {\n                headers: { Authorization: `Bearer ${token}` },\n            });\n            const data = await res.json();\n            setAllUsers(data.users);\n        };\n\n        fetchUsers();\n\n        // const interval = setInterval(fetchUsers, 10000);\n        // return () => clearInterval(interval);\n\n    }, []);\n\n    // fetch conversations when the page loads\n    useEffect(() => {\n        const token = localStorage.getItem('token');\n        if (!token) {\n            router.push('/login');\n            return;\n        }\n\n        const fetchConversations = async () => {\n            const res = await fetch('http://localhost:6543/api/conversations', {\n                headers: {\n                    Authorization: `Bearer ${token}`,\n                },\n            });\n            const data = await res.json();\n            setConversations(data.conversations);\n        };\n\n        fetchConversations(); // initial load\n        // const interval = setInterval(fetchConversations, 2000); // update every 2 seconds\n\n        // return () => clearInterval(interval);\n    }, []);\n\n    // fetch messages when a conversation is selected\n    useEffect(() => {\n        if (!selectedConversation) return;\n\n        const fetchMessages = async () => {\n            const res = await fetch(`http://localhost:6543/api/conversations/${selectedConversation.id}/messages`, {\n                headers: {\n                    Authorization: `Bearer ${localStorage.getItem('token')}`,\n                },\n            });\n\n            const data = await res.json();\n            setMessages(data.messages);\n        };\n\n        fetchMessages(); // fetch immediately when conversation is selected\n\n        // const interval = setInterval(fetchMessages, 2000);\n\n        // return () => clearInterval(interval);\n    }, [selectedConversation]);\n\n    // handle when user sends a new message in current conversation\n    const handleSendMessage = async () => {\n        if (newMessage.trim() && selectedConversation) {\n            // const res = await fetch(`http://localhost:6543/api/conversations/${selectedConversation?.id}/messages`, {\n            //     method: 'POST',\n            //     headers: {\n            //         'Content-Type': 'application/json',\n            //         'Authorization': `Bearer ${localStorage.getItem('token')}`,\n            //     },\n            //     body: JSON.stringify({ content: newMessage }),\n            // });\n\n            socketRef.current?.emit('send_message', {\n                senderId: currentUserId,\n                recipientId: selectedConversation.id,\n                content: newMessage,\n            });\n\n            setNewMessage('');\n        }\n    };\n\n    return (\n        <div className=\"flex min-h-screen\">\n            <div className=\"w-1/4 p-4 border-r\">\n                <button\n                    className=\"mb-4 bg-green-500 text-white py-1 px-3 rounded hover:bg-green-600\"\n                    onClick={() => setShowUserList(!showUserList)}\n                >\n                    New Message\n                </button>\n\n                {showUserList && (\n                    <ul className=\"mb-4 max-h-40 overflow-y-auto border rounded p-2 bg-black\">\n                        {allUsers.map((user) => (\n                            <li\n                                key={user.id}\n                                onClick={() => {\n                                    setSelectedConversation(user);\n                                    setShowUserList(false);\n                                }}\n                                className=\"cursor-pointer hover:bg-gray-100 p-1 rounded\"\n                            >\n                                {user.username ?? user.email}\n                            </li>\n                        ))}\n                    </ul>\n                )}\n                <h2 className=\"text-2xl font-semibold mb-4\">Conversations</h2>\n                <ul className=\"mb-4 max-h-40 overflow-y-auto border rounded p-2 bg-black\">\n                    {conversations.map((conversation) => (\n                        <li\n                            key={conversation.id}\n                            onClick={() => setSelectedConversation(conversation)}\n                            className=\"cursor-pointer hover:bg-gray-200 p-2 rounded mb-2\"\n                        >\n                            {conversation.username ?? conversation.email ?? 'Unnamed'}\n                        </li>\n                    ))}\n                </ul>\n            </div>\n\n            <div className=\"flex-1 p-4\">\n                {selectedConversation ? (\n                    <>\n                        <h2 className=\"text-2xl font-semibold mb-4\">{selectedConversation.username ?? selectedConversation.email}</h2>\n                        <div className=\"space-y-4 h-[60vh] overflow-y-scroll border-b pb-4\">\n                            {messages.map((message, index) => (\n                                <div key={index} className=\"flex flex-col\">\n                                    <div className=\"font-semibold text-gray-600\">\n                                        {message.senderId === currentUserId ? 'You' : message.senderUsername}\n                                    </div>\n                                    <div>{message.content}</div>\n                                    <div className=\"text-sm text-gray-400\">{new Date(message.timestamp).toLocaleString('en-US', {\n                                        timeZone: 'America/Los_Angeles',\n                                        hour: '2-digit',\n                                        minute: '2-digit',\n                                        hour12: true,\n                                    })}</div>\n                                </div>\n                            ))}\n                            <div ref={messagesEndRef} />\n                        </div>\n                        <div className=\"mt-4\">\n                            <input\n                                type=\"text\"\n                                value={newMessage}\n                                onChange={(e) => setNewMessage(e.target.value)}\n                                className=\"w-full p-2 border rounded\"\n                                placeholder=\"Type a message...\"\n                            />\n                            <button\n                                onClick={handleSendMessage}\n                                className=\"w-full bg-blue-500 text-white py-2 mt-2 rounded hover:bg-blue-600\"\n                            >\n                                Send\n                            </button>\n                        </div>\n                    </>\n                ) : (\n                    <div className=\"text-center\">Select a conversation to view messages</div>\n                )}\n            </div>\n        </div>\n    );\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}